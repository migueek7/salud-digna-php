//"https://api.emarketingsd.org/covid19/Covid/"
//http://emarketing.beta.it/Covid19/Covid/
//http://localhost:63051/Covid/
var configCovid = { urlCovid: "https://api.emarketingsd.org/covid19/Covid/", idPaciente: "", idIntento: "", idSucursal: 0, Folio: 0, idHoraSis: "", textHoraSis: "", jsonEstudio: {}, arregloEstudios: [], arrayHorariosSis: [] },
    blackbox = "",
    token = "",
    solicitud = "",
    reiniciarCronometro = 0,
    FechaActual = new Date(),
    HoraCorreo = FechaActual.getDate() + "" + FechaActual.getHours() + FechaActual.getMinutes() + FechaActual.getSeconds();
function validarPaciente(o, a) {
    (null != o && null != o && "" != o) || (o = "Generico" + HoraCorreo + "@gmail.com"),
        console.log(HoraCorreo),
        $.ajax({
            type: "GET",
            url: configCovid.urlCovid + "ValidarPaciente?correo=" + o + "&telefono=" + a,
            dataType: "json",
            async: !0,
            success: function (e) {
                console.log(e),
                    0 == e.flagBloqueado ? (1 == e.estatusPaciente ? ((configCovid.idPaciente = e.idPaciente), pasarPaso2()) : 4 == e.estatusPaciente ? mostrarMsjRegistroPrevio() : guardarPacienteParcial(o, a)) : mostrarMsjBloqueado();
            },
            error: function (o, a, e) {
                console.log(e);
            },
        });
}
function guardarPacienteParcial(o, a) {
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "GuardarPaciente",
        async: !1,
        data: { Correo: o, TelefonoCelular: a, GuardadoParcial: 1 },
        dataType: "json",
        success: function (o) {
            2 == o.status ? mostrarMsjRegistroPrevio() : ((configCovid.idPaciente = o.IdPaciente), pasarPaso2());
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
function mostrarMsjBloqueado() {
    ScrollTop(), $("#item1Pasos").hide(), $("form").hide(), $(".mensaje_24hrs").show();
}
function mostrarMsjRegistroPrevio() {
    ScrollTop(), $("#item1Pasos").hide(), $("form").hide(), $(".mensaje_registrado").show();
}
function pasarPaso2() {
    $('html, body').animate({
        scrollTop: $(".formulario").offset().top-70
    }, 2000), $("form").hide(), $("#form2").show();
    
    $("#ContadorCitaGeneral").slideDown("slow");
    $("#ContadorCita1").slideUp("slow");
    $("#ContadorCita2").slideUp("slow");
}
function pasarPaso3() {
    ScrollTop(), $("form").hide(), $("#form3").show();
}
function regresarDatosPaciente() {
    $('html, body').animate({
        scrollTop: $("#contDatos1").offset().top-120
    }, 2000), $("form").hide(), $("#form1").show();
}

function crearJsonRespuestas() {
    var o = { PreguntasAbiertas: [] };
    o.IdIntento = configCovid.idIntento;
    o.IdPaciente = configCovid.idPaciente;
    var a = [];
    // "-1" == $(".Motivo_Prueba").val() ? a.push($(".Motivo_Prueba").attr("data-no")) : a.push($(".Motivo_Prueba").val()),
        "-1" == $(".Seguridad_social").val() ? a.push($(".Seguridad_social").attr("data-no")) : a.push($(".Seguridad_social").val()),
    // "-1" == $(".TipoSangre").val() ? a.push($(".TipoSangre").attr("data-no")) : a.push($(".TipoSangre").val()),
        "-1" == $(".Ocupacion").val() ? a.push($(".Ocupacion").attr("data-no")) : a.push($(".Ocupacion").val());
    var e = $("#respesutaOpcional").find(".si_no_option .item.active").attr("data-value");
    "si" == e ? a.push($("#respesutaOpcional").find(".si_no_option .item.active").attr("data-si")) : "no" == e && a.push($("#respesutaOpcional").find(".si_no_option .item.active").attr("data-no")),
        "si" == $("#respesuta4").find(".si_no_option .item.active").attr("data-value")
            ? ($("#respesuta4 .respuesta-si input").map(function (o, e) {
                  $(e).is(":checked") && a.push($(e).attr("data-si"));
              }),
              a.push($(".FechaCuandoPreg4").attr("data-si")),
              o.PreguntasAbiertas.push({ IdRespuesta: $(".FechaCuandoPreg4").attr("data-si"), Respuesta: $(".FechaCuandoPreg4").val() }))
            : a.push($("#respesuta4").find(".si_no_option .item.active").attr("data-no"));
    var t = "177";
    if (
        ($('#respesuta5 input[type="checkbox"]').map(function (o, e) {
            $(e).is(":checked") ? (a.push($(e).attr("data-si")), ("51" != $(e).attr("data-si") && "61" != $(e).attr("data-si") && "59" != $(e).attr("data-si") && "55" != $(e).attr("data-si")) || (t = "176")) : a.push($(e).attr("data-no"));
        }),
        a.push(t),
        $(".OtroSintoma5").is(":checked"))
    ) {
        var i = $(".InputOtroSintoma5").attr("data-si"),
            n = $(".InputOtroSintoma5").val();
        o.PreguntasAbiertas.push({ IdRespuesta: i, Respuesta: n });
    }
    var r = $(".FechaSintomasContagio").attr("data-si"),
        s = $(".FechaSintomasContagio").val();
    if (
        (o.PreguntasAbiertas.push({ IdRespuesta: r, Respuesta: s }),
        a.push(r),
        "si" == $("#respesuta6").find(".si_no_option .item.active").attr("data-value")
            ? $('#respesuta6 input[type="checkbox"]').map(function (o, e) {
                  $(e).is(":checked") && a.push($(e).attr("data-si"));
              })
            : a.push($("#respesuta6").find(".si_no_option .item.active").attr("data-no")),
        $(".OtroSintoma6").is(":checked"))
    ) {
        var c = $(".InputOtroSintoma6").attr("data-si"),
            d = $(".InputOtroSintoma6").val();
        o.PreguntasAbiertas.push({ IdRespuesta: c, Respuesta: d });
    }
    if("si" == $("#respesuta12").find(".si_no_option .item.active").attr("data-value")){
        a.push($("#respesuta12").find(".si_no_option .item.active").attr("data-si"));
    }
    else if ("no" == $("#respesuta12").find(".si_no_option .item.active").attr("data-value")){
        a.push($("#respesuta12").find(".si_no_option .item.active").attr("data-no"));
    }
    else{
        a.push($("#respesuta12").find(".si_no_option .item.active").attr("data-no"));
    }
    if (
        //("si" == $("#respesuta7").find(".si_no_option .item.active").attr("data-value") ? a.push("92") : a.push($("#respesuta7").find(".si_no_option .item.active").attr("data-no")),
        ("si" == $("#respesuta7").find(".si_no_option .item.active").attr("data-value")
            ? ( a.push($(".Preg7Answ .fila .caja-radio label input[type='radio'][name='radio']:checked").attr("data-si")), 
                a.push($(".Preg7Answ .fila .caja-radio label input[type='radio'][name='radioMarca']:checked").attr("data-si")),
                ($(".Preg7Answ .fila .caja-radio label input[type='radio'][name='radio']:checked").attr("data-si") == "166") 
                ? (x = $(".Preg7Answ .fila .caja-radio label input[type='radio'][name='radio']:checked").attr("data-si"),
                    y = $(".FechaDosis1").val(),
                    o.PreguntasAbiertas.push({ IdRespuesta: x, Respuesta: y }))
                : (x = $(".Preg7Answ .fila .caja-radio label input[type='radio'][name='radio']:checked").attr("data-si"),
                    y = "Fecha1: " + $(".FechaDosis1").val() + " - Fecha2: " + $(".FechaDosis2").val(),
                    o.PreguntasAbiertas.push({ IdRespuesta: x, Respuesta: y }))
              )
            : a.push($("#respesuta7").find(".si_no_option .item.active").attr("data-no")),
        "si" == $("#respesuta8").find(".si_no_option .item.active").attr("data-value")
            ? a.push($("#respesuta8").find(".si_no_option .item.active").attr("data-si"))
            : a.push($("#respesuta8").find(".si_no_option .item.active").attr("data-no")),
        "si" == $("#respesuta9").find(".si_no_option .item.active").attr("data-value")
            ? $('.Preg9Answ input[type="checkbox"]').map(function (o, e) {
                  $(e).is(":checked") && a.push($(e).attr("data-si"));
              })
            : a.push($("#respesuta9").find(".si_no_option .item.active").attr("data-no")),
        "si" == $("#respesuta11").find(".si_no_option .item.active").attr("data-value"))
    )
        a.push($("#respesuta11").find(".si_no_option .item.active").attr("data-si"));
    else {
        var l = $(".DondeCuandoPrueba").attr("data-no"),
            u = $(".DondeCuandoPrueba").val();
        o.PreguntasAbiertas.push({ IdRespuesta: l, Respuesta: u }), a.push(l);
        var p = $(".FechaPrueba").attr("data-no"),
            m = $(".FechaPrueba").val();
        o.PreguntasAbiertas.push({ IdRespuesta: p, Respuesta: m }),
            a.push(p),
            $('#respesuta11 input[type="checkbox"]').map(function (o, e) {
                $(e).is(":checked") && a.push($(e).attr("data-no"));
            });
    }

    /*var Idcalle = $(".calle_cita").attr("data-si");
    var RespCalle = "";
    if ( $("#colonia_cita option:selected").val() == "0" ) {

        if ($(".calle_cita").val() == "No definido") {
            RespCalle = "Col. No definida Calle No requerida";
        }else{
            RespCalle = "Col. No definida Calle " + $(".calle_cita").val() + " #" + $("#numero_casa_cita ").val();
        }

    }else if ( $(".calle_cita").val() == "No definido" ){
        RespCalle = "Col. " + $("#colonia_cita option:selected").text().toLowerCase() + " Calle No definida";
    }else{
        RespCalle = "Col. " + $("#colonia_cita option:selected").text().toLowerCase() + " Calle " + $(".calle_cita").val() + " #" + $("#numero_casa_cita ").val();
    }
    
   var RespCalle = "Col. " + $("#colonia_cita option:selected").text().toLowerCase() + " Calle " + $(".calle_cita").val() + " #" + $("#numero_casa_cita").val();
    o.PreguntasAbiertas.push({ IdRespuesta: Idcalle, Respuesta: RespCalle });
    a.push(Idcalle);
    */
    return (o.Respuestas = a), o;
}
function guardarIntento() {
    var o;
    (o = crearJsonRespuestas()),
        $.ajax({
            type: "POST",
            url: configCovid.urlCovid + "GuardarIntento",
            async: !1,
            data: o,
            dataType: "json",
            success: function (o) {
                -1 == o.status || (1 == o.statusBloqueado ? pacienteBloqueadoPaso3() : ((configCovid.idIntento = o.idIntento), pasarPaso4(), ActualizarIntento()));
            },
            error: function (o, a, e) {
                console.log(e);
            },
        });
}
function ObtenerColonias(IdMunicipio) {
    var CP = $("#codigo_postal_cita").val();
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "ObtenerColonias?IdMunicipio="+IdMunicipio+"&CP="+CP,
        async: !1,
        data: { IdMunicipio: IdMunicipio, CP: CP },
        dataType: "json",
        success: function (resp) {
            $("#colonia_cita option").remove();
            $("#colonia_cita").append("<option value='-1'>Selecciona Colonia</option>");
            if (resp.length > 0) {
                $.each(resp, function (i, item_colonia) {
                    $("#colonia_cita").append(
                        "<option value='"+item_colonia.Id+"'>"+item_colonia.DescripcionColonia+"</option>"
                    );
                });
                $(".ContNoColonia").slideUp("slow");
                $(".overlay_loading").css("display", "none");
            }else{
                $(".ErrorCP").css("display", "block").slideDown().text("El codigo postal no pertenece a el municipio seleccionado.");
                $(".ContNoColonia").slideDown("slow");
                $(".overlay_loading").css("display", "none");
            }
        },
        error: function (o, a, e) {
            $(".overlay_loading").css("display", "none");
            $(".ContNoColonia").slideDown("slow");
            $(".ErrorCP").css("display", "block").slideDown().text("Ingresa el Código Postal más cercano a tu colonia.");
        },
    });
}
function MostrarErrorCP(){
    $(".ErrorCP").css("display", "block").text("Ingresa el Código Postal más cercano a tu colonia.");
}
function generarCodigoQR(o) {
    var a = "";
    return (
        $.ajax({
            type: "POST",
            url: "https://qr-code.salud-digna.site/qr/generate",
            dataType: "JSON",
            async: !1,
            data: { code: o },
            success: function (o) {
                a = o.base;
            },
            error: function (o, a, e) {},
        }),
        a
    );
}
function pacienteBloqueadoPaso3() {
    ScrollTop(), $("form").hide(), $(".sinSintomas").show();
}
function pasarPaso4() {
    $('html, body').animate({
        scrollTop: $(".formulario").offset().top-70
    }, 2000), $("form").hide(), $("#form4").show();

    /*
    $(".pago_en_oxxo").remove();
    $(".pago_coppel").css("padding-left","15px");
    $(".pago_coppel").css("padding-right","0px");
    $(".pago_en_clinica").css("padding-left","0px");
    $(".pago_en_clinica").css("padding-right","15px");
    */

    /*
    (163 != app.IdSucursal && 153 != app.IdSucursal && 148 != app.IdSucursal && 126 != app.IdSucursal && 97 != app.IdSucursal && 89 != app.IdSucursal && 88 != app.IdSucursal && 81 != app.IdSucursal && 79 != app.IdSucursal && 73 != app.IdSucursal && 59 != app.IdSucursal 
        && 54 != app.IdSucursal && 46 != app.IdSucursal && 42 != app.IdSucursal && 12 != app.IdSucursal) ||
        $(".pago_en_clinica").remove();
    */
    
}
// function obtenerSucursal() {
//     $.ajax({
//         type: "GET",
//         url: configCovid.urlCovid + "ObtenerSucursales",
//         async: !1,
//         dataType: "json",
//         beforeSend: function () {
//             $("#clinica_cita").find("option").remove().end().append('<option value="">Cargando...</option>');
//         },
//         success: function (o) {
//             $("#clinica_cita option").remove(),
//                 $("#clinica_cita").append($("<option></option>").attr("value", "").text("Seleccione una sucursal")),
//                 o.sucursales.map(function (o, a) {
//                     $("#clinica_cita").append($("<option></option>").attr({ value: o.IdSucursal }).text(o.Sucursal));
//                 }),
//                 $("#clinica_cita").attr("disabled", !1);
//         },
//         error: function (o, a, e) {
//             console.log(e);
//         },
//     });
// }
function SubEstudiosPorSucursal(o) {
    if(o != null || o >= 1 || o != undefined){
        $.ajax({
            type: "GET",
            url: configCovid.urlCovid + "SubEstudiosPorSucursal",
            async: !1,
            dataType: "json",
            data: { sucursal: o },
            success: function (o) {
                $("#fecha_cita").datepicker( "destroy" ),console.log(o), $(".overlay_loading").css("display", "none"), o.length > 0 && ((configCovid.jsonEstudio = o[0]), pintarEstudio(o[0]));
            },
            error: function (o, a, e) {
                console.log(e), $(".overlay_loading").css("display", "none"), $(".hora_cita").val(0), $(".fecha_cita ").val(""), $(".clinica_cita").val(0), $(".estado_clinica_cita").val(-1), configCovid.jsonEstudio = "", validarCamposVacionForm1();
            },
        });
    }else{
        console.log('No se envio IdSucursal'),
        $(".overlay_loading").css("display", "none"),
        $(".hora_cita").val(0),
        $(".fecha_cita ").val(""),
        $(".clinica_cita").val(0),
        $(".estado_clinica_cita").val(-1),
        configCovid.jsonEstudio = "",
        validarCamposVacionForm1();
    }
}

var fechaCitaGlobal = "";
var idHorario = 0;
var horarioQuemadoId = 0;
$("#hora_cita").change(function () {
    
    if(idHorario != 0){
        //Debloquear el horario anterior y comenzar el timer de nuevo en 8 mins
        $.ajax({
            type: "POST",
            url: "https://servicios.salud-digna.org/horarios/pcr/bloquear",
            async: !1,
            dataType: "json",
            data: { idHorario: idHorario, time: 0 },
            success: function (o) {
                if (o.typeHorario == "pcr") {
                    //console.log("horario: "+ idHorario + " desbloqueado con éxito.");
                }
            },
            error: function (o, a, e) {
                console.log(e + " -  Error al apartar horario");
            },
        });
    }

    $.ajax({
        type: "POST",
        url: "https://servicios.salud-digna.org/horarios/pcr/bloquear",
        async: !1,
        dataType: "json",
        data: { idHorario: parseInt($(".hora_cita option:selected").val()), time: 8 },
        success: function (o) {
            if (o.typeHorario == "pcr") {
                if(idHorario != 0)
                    countDown(1);
                else
                    countDown();
            }
        },
        error: function (o, a, e) {
            console.log(e + " -  Error al apartar horario");
            $(".hora_cita").val(0), $(".fecha_cita ").val(""), $(".clinica_cita").val(0), $(".estado_clinica_cita").val(-1), configCovid.jsonEstudio = "", validarCamposVacionForm1();
            return false;
        },
    });
    idHorario = $("#hora_cita option:selected").val();
    //console.log(idHorario);
    var horario_seleccionado = $("#hora_cita option:selected").text();
    var array_horarios = ['6:45 PM', '6:50 PM', '6:55 PM', '7:55 PM', '8:00 PM', '8:05 PM', '8:10 PM', '8:15 PM', '8:20 PM', '8:25 PM', '8:30 PM', '8:35 PM', '8:40 PM', '8:45 PM',
    '8:50 PM', '8:55 PM', '9:00 PM', '9:05 PM', '9:10 PM', '9:15 PM', '9:20 PM', '9:25 PM', '9:30 PM', '9:35 PM', '9:40 PM', '9:45 PM', '9:50 PM', '9:55 PM', '10:00 PM', '10:05 PM', '10:10 PM', '10:15 PM', '10:20 PM',
    '10:25 PM', '10:30 PM', '10:35 PM', '10:40 PM', '10:45 PM'];

    var IdSucursal = parseInt(app.IdSucursal);
    if(IdSucursal == 54) //Zapopan las aguilas
    {
        if(array_horarios.includes(horario_seleccionado)){
            $(".pago_en_clinica").remove();
        }
    }

})

function pintarEstudio(resp) {
    $(".resumen_cita .detalle-estudio span:nth-child(3)").html("$"+Math.round(resp.Precio));
    //$(".resumen_cita .detalle-paquete span:nth-child(3)").html("$490.00");
    $(".resumen_cita .totales span:nth-child(2)").html("$"+Math.round(resp.Precio));
    incluyePaquete = false;
    $(".banner-seguimiento").show();
    /*
    if(incluyePaquete){
        $(".resumen_cita .totales span:nth-child(2)").html("$1,440.00");
        $(".banner-seguimiento").hide();
    } else {
        $(".resumen_cita .totales span:nth-child(2)").html("$950.00");
        $(".banner-seguimiento").show();
    }
    */
    var IdSucursal = parseInt(app.IdSucursal);
    var FechaLimite = 2;
    var Hora = parseInt(resp.Horario.split(":", 1)) + 1;
    if ( IdSucursal == 162 || IdSucursal == 42 || IdSucursal == 82 || IdSucursal == 61 || IdSucursal == 104 || IdSucursal == 54 ) {
        //A las 12
        if (Hora >= 12) {
            FechaLimite = 3
        }
    }else if( IdSucursal == 128 || IdSucursal == 137 || IdSucursal == 103 || IdSucursal == 117 || IdSucursal == 156 || IdSucursal == 141 ){
        //A las 16
        if (Hora >= 16) {
            FechaLimite = 3
        }
    }else if( IdSucursal == 153 || IdSucursal == 148 || IdSucursal == 46 || IdSucursal == 96 || IdSucursal == 86 || IdSucursal == 79 || IdSucursal == 68 || IdSucursal == 98 || IdSucursal == 81 || IdSucursal == 87 || IdSucursal == 102 || IdSucursal == 88 || IdSucursal == 73 || IdSucursal == 59 || IdSucursal == 133 || IdSucursal == 111){
        //A las 18
        if (Hora >= 18) {
            FechaLimite = 3
        }
    }else if( IdSucursal == 164 || IdSucursal == 165 || IdSucursal == 40 || IdSucursal == 9 || IdSucursal == 139 || IdSucursal == 12 || IdSucursal == 33 || IdSucursal == 134 || IdSucursal == 84 || IdSucursal == 144 || IdSucursal == 152 || IdSucursal == 47 || IdSucursal == 57 || IdSucursal == 56 || IdSucursal == 149 || IdSucursal == 71 || IdSucursal == 48 || IdSucursal == 147 || IdSucursal == 129 || IdSucursal == 60 || IdSucursal == 158 || IdSucursal == 119 || IdSucursal == 123 || IdSucursal == 97 || IdSucursal == 155 || IdSucursal == 52 || IdSucursal == 108 || IdSucursal == 150 || IdSucursal == 41 || IdSucursal == 1 || IdSucursal == 109 || IdSucursal == 5 || IdSucursal == 6 || IdSucursal == 37 || IdSucursal == 25 || IdSucursal == 125 || IdSucursal == 142 || IdSucursal == 138 || IdSucursal == 127 || IdSucursal == 143 || IdSucursal == 159 || IdSucursal == 107 || IdSucursal == 113 ){
        //A las 13
        if (Hora >= 13) {
            FechaLimite = 3
        }
    }

    var diasDisponiblesJson = ObtenerDiasDisponiblesPorClinica(IdSucursal);
    $("#fecha_cita").datepicker({
        minDate: resp.Fecha,
        maxDate: FechaLimite,
        dateFormat: "dd/mm/yy",
        beforeShowDay: function (date){
            return colorearDias(diasDisponiblesJson, date);
        },
        onSelect: function (a) {
            $("#fecha_cita").addClass("lleno"),
                $(".resumen_cita .detalle-estudio span:nth-child(2)").html(a),
                $(".overlay_loading").css("display", "flex"),
                setTimeout(function () {
                    horariosDisponibleEspecifico(2, $("#clinica_cita").val(), a, configCovid.jsonEstudio.Id) && getHorario(a), validarCamposVacionForm1();
                }, 1e3);
        },
    });
    $('.ui-datepicker').addClass('notranslate');
    var descripcion = "Disponibilidad";
    var noDisponible = "Sin disponibilidad";
    
    $( "#fecha_cita" ).datepicker().focus(function() {
        if ($('#ui-datepicker-div :last-child').is('table'))
        $('#ui-datepicker-div').append('<span style = "height: 15px;width: 15px;  border-radius: 50%; display: inline-block;background-color: #2EAD6D; margin-left: 3px;"></span>'
        +'<span style = "margin-left: 5px; margin-right: 15px; font-size: 12px">'+descripcion+'</span>'
        +'<span style = "height: 15px;width: 15px;  border-radius: 50%; display: inline-block;background-color: red;"></span>'
        +'<span style = "margin-left: 5px; font-size: 12px">'+noDisponible+'</span>');
    });
}
function getHorario(o) {
    HorariosDisponibleCovid($("#clinica_cita").val(), o);
}
function HorariosDisponibleCovid(o, a) {
    o = parseInt(o);
    var arrFecha = a.split("/");
    var fecha = arrFecha[2] + "-" + arrFecha[1] + "-" + arrFecha[0];
    var consultarHorarios = {sucursalId : o, fechaCita: fecha};
    console.log(consultarHorarios);
    $.ajax({
        type: "GET",
        //url: configCovid.urlCovid + "/HorariosDisponibleCovid",
        //data: { idSucursal: o, fecha: a, Origen: "1" },
        url: "https://servicios.salud-digna.org/horarios/pcr/disponibles?sucursal="+o+"&fecha="+a,
        dataType: "json",
        contentType: "application/json",
        beforeSend: function (o) {
            $("#hora_cita").find("option").remove().end().append('<option value="">Cargando...</option>');
        },
        success: function (o) {
            if (($("#MandarAvisoCitas, .TextoClinicaCercana").hide(), console.log(o), $("#hora_cita option").remove(), o.length >= 1)) {
                var a = 0;
                $("#hora_cita").append('<option value="">Seleccione una hora</option>'),
                    o.map(function (o, e) {
                        validarHorariosEnSis(configCovid.arrayHorariosSis, o.Descripcion) && ($("#hora_cita").append($("<option></option>").attr({ value: o.Id }).text(o.Descripcion)), a++);
                    }),
                    0 == a && ($("#hora_cita option").remove(), $("#hora_cita").append($("<option></option>").attr("value", "").text("Horarios agotados")), $("#MandarAvisoCitas").show(), ClinicasCercanas()),
                    $("#hora_cita").attr("disabled", !1);
            } else $("#hora_cita").append($("<option></option>").attr("value", "").text("Horarios agotados")), $("#MandarAvisoCitas").show(), ClinicasCercanas();
        },
        error: function (o, a, e) {
            console.log(e), $("#hora_cita option").remove(), $("#hora_cita").append($("<option></option>").attr("value", "").text("Horarios agotados")), $("#MandarAvisoCitas").show();
        },
    });
}
function ClinicasCercanas(){
    $.ajax({
        type: "GET",
        url: "https://servicios.salud-digna.org/horarios/pcr/carrusel",
        data: { 
            estado: parseInt($(".estado_clinica_cita").val()),
            fecha: $("#fecha_cita").val()
        },
        dataType: "json",
        beforeSend: function (o) {
            $("#contenedor-cargando-carrousel").slideDown("slow");
            $(".CarruselClinicasCercanas, .TextoClinicaCercana").slideUp("slow")
        },
        success: function (o) {
            if (o.length >= 1) {
                var htmlDinamicoInicio = "";
                var htmlDinamicoSiguiente = "";
                var htmlDinamicoUltimo = "";
                var IdMunicipio = parseInt($(".clinica_cita option:selected").attr("idmunicipio"));
                var divClinicaCercana = "<div class='divClinicaCercana'> <div class='FondoIconoClinica'><img class='IconoClinica' src='https://salud-digna.com/citasCovid19/Iconos clinica_Clínica.svg'><span style='height: 15px;width: 15px;  border-radius: 50%; display: inline-block;background-color: #2EAD6D; margin-top: 8px;'></span></div>";
                for (var i = 0; i < o.length; i++){
                    if (o[i].sucursal.id != 55 || o[i].sucursal.id != 85 || o[i].sucursal.id != 161) {

                                htmlDinamicoUltimo += divClinicaCercana;
                                htmlDinamicoUltimo += "<section class='ClinicaCercana'>";
                                htmlDinamicoUltimo += '<span style="font-weight: normal;text-align: left;font-size: 12px; margin-bottom:5px;">¡Horarios disponibles!</span>';
                                htmlDinamicoUltimo += "<span>"+ o[i].sucursal.nombre +"</span>";
                                htmlDinamicoUltimo += "<div class='SelecCliCer' clinica='"+o[i].sucursal.nombre+"' direccion='"+o[i].sucursal.domicilio+"' IdClinica='"+o[i].sucursal.id+"''>Cambiar</div>";
                                htmlDinamicoUltimo += "</section> </div>";
                    }//Fin if sucursales
                }//Fin for
                $(".ContClinicarCercanas").html(htmlDinamicoInicio + htmlDinamicoSiguiente + htmlDinamicoUltimo);
                $("#contenedor-cargando-carrousel").slideUp("slow");
                if (o.length > 0) {
                    $(".CarruselClinicasCercanas, .TextoClinicaCercana").slideDown("slow");
                }
            }else{
                $("#contenedor-cargando-carrousel, .CarruselClinicasCercanas, .TextoClinicaCercana").slideUp("slow");
            }//Fin if
        },//Fin succes
        error: function (o, a, e) {
            $("#contenedor-cargando-carrousel, .CarruselClinicasCercanas, .TextoClinicaCercana").slideUp("slow");
            console.log(e);
        },
    });
}
$(document).on("click", ".SelecCliCer", function() {
    app.IdSucursal = parseInt($(this).attr("idclinica"));
    configCovid.idSucursal = parseInt($(this).attr("idclinica"));

    if(163 == app.IdSucursal || 109 == app.IdSucursal || 150 == app.IdSucursal || 41 == app.IdSucursal || 6 == app.IdSucursal || 5 == app.IdSucursal || 1 == app.IdSucursal)
    { $("#direccion_cita").css("display", "flex"); $("#calle_cita").val(""); $("#numero_casa_cita").val(""); }
    else{ $("#direccion_cita").css("display", "none"); $("#calle_cita").val("default"); $("#numero_casa_cita").val("000"); }

    $.ajax({
        type: "GET",
        url: configCovid.urlCovid + "SubEstudiosPorSucursal",
        async: !1,
        dataType: "json",
        data: { sucursal: app.IdSucursal },
        success: function (o) {
            o.length > 0 && ((configCovid.jsonEstudio = o[0]), $("#fecha_cita").datepicker( "destroy" ), pintarEstudio(o[0]), $("#fecha_cita").blur());
        },
        error: function (o, a, e) {
            $(".CarruselClinicasCercanas, .TextoClinicaCercana, #MandarAvisoCitas, .ContUbicacionClinica").slideUp("slow");
            $(".hora_cita").val(0), $(".fecha_cita ").val(""), $(".clinica_cita").val(0), $(".estado_clinica_cita").val(-1), configCovid.jsonEstudio = "", validarCamposVacionForm1();
            return false;
        },
    });

    var DireccionClinica = $(this).attr("direccion");
    var NombreClinica = $(this).attr("clinica");

    $(".clinica_cita").val(app.IdSucursal);
    $(".CarruselClinicasCercanas, .TextoClinicaCercana, #MandarAvisoCitas, .ContUbicacionClinica, .SucursalClinica").slideUp("slow");

    var Variable = "horariosDisponibleEspecifico/" + $("#fecha_cita").val() + "-" + app.IdSucursal;
    var VariableRecuperada = localStorage.getItem(Variable);

    if (VariableRecuperada != undefined) {
        var HorariosLocal = JSON.parse(VariableRecuperada);
        configCovid.idHoraSis = HorariosLocal[0].Horarios[0].Id,
        configCovid.textHoraSis = HorariosLocal[0].Horarios[0].Hora.split("-")[0],
        configCovid.arrayHorariosSis = HorariosLocal[0].Horarios;

    }else{
        var n = [];
        n.push({ IdEstudio: 2, IdSucursal: app.IdSucursal, Fecha: $("#fecha_cita").val(), IdSubEstudio: configCovid.jsonEstudio.Id });
        $.ajax({
            type: "POST",
            url: configCovid.urlCovid + "HorariosDisponibleEspecifico",
            async: !1,
            dataType: "json",
            data: { ListaHorarios: n },
            success: function (o) {
                    o.Estatus
                        ? ((configCovid.idHoraSis = o.Horarios[0].Horarios[0].Id), (configCovid.textHoraSis = o.Horarios[0].Horarios[0].Hora.split("-")[0]), (configCovid.arrayHorariosSis = o.Horarios[0].Horarios))
                        : ($(".hora_cita").val(0), $(".fecha_cita ").val(""), $(".clinica_cita").val(0), $(".estado_clinica_cita").val(-1), configCovid.jsonEstudio = "", validarCamposVacionForm1());
            },
            error: function (o, a, e) {
                console.log(e);
                $(".hora_cita").val(0), $(".fecha_cita ").val(""), $(".clinica_cita").val(0), $(".estado_clinica_cita").val(-1), configCovid.jsonEstudio = "", validarCamposVacionForm1();
                return false;
            },
        });
    }

    HorariosDisponibleCovid(app.IdSucursal, $("#fecha_cita").val());

    (155 != app.IdSucursal &&
        148 != app.IdSucursal &&
        144 != app.IdSucursal &&
        73 != app.IdSucursal &&
        61 != app.IdSucursal &&
        59 != app.IdSucursal &&
        42 != app.IdSucursal &&
        9 != app.IdSucursal && 
        1 != app.IdSucursal) ||
        $(".UbicacionHorarioClinica").html("Lunes a Sab: 7:00 am a 7:00 pm </br> Domingo: 7:00 am a 5:00 pm"),
    (167 != app.IdSucursal &&
        166 != app.IdSucursal &&
        164 != app.IdSucursal &&
        162 != app.IdSucursal &&
        159 != app.IdSucursal &&
        153 != app.IdSucursal &&
        152 != app.IdSucursal &&
        150 != app.IdSucursal &&
        143 != app.IdSucursal &&
        142 != app.IdSucursal &&
        141 != app.IdSucursal &&
        139 != app.IdSucursal &&
        138 != app.IdSucursal &&
        137 != app.IdSucursal &&
        133 != app.IdSucursal &&
        132 != app.IdSucursal &&
        129 != app.IdSucursal &&
        128 != app.IdSucursal &&
        127 != app.IdSucursal &&
        126 != app.IdSucursal &&
        125 != app.IdSucursal &&
        123 != app.IdSucursal &&
        119 != app.IdSucursal &&
        117 != app.IdSucursal &&
        113 != app.IdSucursal &&
        109 != app.IdSucursal &&
        108 != app.IdSucursal &&
        107 != app.IdSucursal &&
        104 != app.IdSucursal &&
        103 != app.IdSucursal &&
        102 != app.IdSucursal &&
        98 != app.IdSucursal &&
        97 != app.IdSucursal &&
        96 != app.IdSucursal &&
        89 != app.IdSucursal &&
        88 != app.IdSucursal &&
        87 != app.IdSucursal &&
        84 != app.IdSucursal &&
        82 != app.IdSucursal &&
        81 != app.IdSucursal &&
        79 != app.IdSucursal &&
        76 != app.IdSucursal &&
        71 != app.IdSucursal &&
        68 != app.IdSucursal &&
        60 != app.IdSucursal &&
        57 != app.IdSucursal &&
        56 != app.IdSucursal &&
        54 != app.IdSucursal &&
        52 != app.IdSucursal &&
        48 != app.IdSucursal &&
        47 != app.IdSucursal &&
        41 != app.IdSucursal &&
        40 != app.IdSucursal &&
        37 != app.IdSucursal &&
        25 != app.IdSucursal &&
        12 != app.IdSucursal &&
        6 != app.IdSucursal &&
        5 != app.IdSucursal) ||
        $(".UbicacionHorarioClinica").html("Lunes a domingo: 7:00 am a 3:00 pm </br>"),
    (134 != app.IdSucursal)  ||
        $(".UbicacionHorarioClinica").html("Lunes a domingo: 7:00 am a 11:30 am </br>"),
    (46 != app.IdSucursal)  ||
        $(".UbicacionHorarioClinica").html("Lunes: 06:00 am a 11:55 pm </br> Martes a Vie: 12:00 am a 11:55 pm </br> Sabado: 12:00 am a 11:00 pm </br> Domingo: 7:00 am a 5:00 pm"),
    (214 != app.IdSucursal)  ||
        $(".UbicacionHorarioClinica").html("Lunes a Sab: 7:00 am a 3:00 pm </br> Domingo: 7:00 am a 2:00 pm"),


    41 == app.IdSucursal || 61 == app.IdSucursal || 68 == app.IdSucursal || 102 == app.IdSucursal || 117 == app.IdSucursal || 109 == app.IdSucursal
    ? ($(".pago_en_clinica").css("display", "none"),
      $(".InformacionCanadas, .CheckCanadas").css("display", "block"),
      $(".ClinicaToma").html($(".estado_clinica_cita option:selected").text()),
      $(".EstadoToma").html($(".clinica_cita option:selected").text()),
      $("#chkTerminosRegistro4").prop("checked", !1))
    : ($(".pago_en_clinica").css("display", "block"), 
        $(".InformacionCanadas, .CheckCanadas").css("display", "none"),
        $("#chkTerminosRegistro4").prop("checked", !0));


    147 == parseInt(app.IdSucursal)
    ? ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text("Blvd. La merced 1702 B, col. Santa Rita. CP. 37450, Entre Blvd. Juan José Torres Landa y Calle Faisán. León, Guanajuato."))
    : ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text(DireccionClinica.toLowerCase()));
    52 == parseInt(app.IdSucursal)
    ? ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text("Calle Radio difusora #19 Colonia centro, Querétaro."))
    : ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text(DireccionClinica.toLowerCase()));
    40 == parseInt(app.IdSucursal)
    ? ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text("Av. Ruiz #485 Col. Sección Primera Entre Av. Juárez Y Cuarta C.P. 22800, Ensenada"))
    : ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text(DireccionClinica.toLowerCase()));
    $(".UbicacionDireccionClinica").css("textTransform", "capitalize");
        $(".NomClinicaSel").text(NombreClinica), $(".DirClinicaSel").text(DireccionClinica.toLowerCase());
        $(".SucursalClinica").slideDown("slow"), $(".SucursalClinica").text(NombreClinica);
        $(".DirClinicaSel").css("textTransform", "capitalize");
        $(".UbicacionDireccionClinica").css("textTransform", "capitalize");
    
    tiemposDeEntregaThankYou(app.IdSucursal);

    // $.ajax({
    //     type: "GET",
    //     url: "https://api.emarketingsd.org/base/Sucursales/Detalle?IdSucursal=" + app.IdSucursal,
    //     async: !1,
    //     dataType: "json",
    //     beforeSend: function (a) {},
    //     success: function (a) {
    //         147 == parseInt(app.IdSucursal)
    //             ? ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text("Blvd. La merced 1702 B, col. Santa Rita. CP. 37450, Entre Blvd. Juan José Torres Landa y Calle Faisán. León, Guanajuato."))
    //             : ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text(a[0].Domicilio));
    //         52 == parseInt(app.IdSucursal)
    //             ? ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text("Calle Radio difusora #19 Colonia centro, Querétaro."))
    //             : ($(".ContUbicacionClinica").slideDown("slow"), $(".UbicacionDireccionClinica").text(a[0].Domicilio));
    //         $(".NomClinicaSel").text(a[0].Descripcion), $(".DirClinicaSel").text(a[0].Domicilio.toLowerCase());
    //         $(".SucursalClinica").slideDown("slow"), $(".SucursalClinica").text(NombreClinica);
    //     },//Fin Success
    // });//Fin Ajax

});//Fin Click SelecClinic
function horariosDisponibleEspecifico(o, a, e, t) {
    var i = !1, n = [];
    var Variable = "horariosDisponibleEspecifico/" + e + "-" + a;
    var VariableRecuperada = localStorage.getItem(Variable);

    if (VariableRecuperada != undefined) {
        var HorariosLocal = JSON.parse(VariableRecuperada);
        return (
            $(".overlay_loading").css("display", "none"),
            (configCovid.idHoraSis = HorariosLocal[0].Horarios[0].Id),
            (configCovid.textHoraSis = HorariosLocal[0].Horarios[0].Hora.split("-")[0]),
            (configCovid.arrayHorariosSis = HorariosLocal[0].Horarios),
            (i = !0),
            i
        );
    }else{
        return (
            n.push({ IdEstudio: o, IdSucursal: a, Fecha: e, IdSubEstudio: t }),
            $.ajax({
                type: "POST",
                url: configCovid.urlCovid + "HorariosDisponibleEspecifico",
                async: !1,
                dataType: "json",
                data: { ListaHorarios: n },
                success: function (o) {
                    $(".overlay_loading").css("display", "none"),
                        o.Estatus
                            ? ((configCovid.idHoraSis = o.Horarios[0].Horarios[0].Id), (configCovid.textHoraSis = o.Horarios[0].Horarios[0].Hora.split("-")[0]), (configCovid.arrayHorariosSis = o.Horarios[0].Horarios), localStorage.setItem(Variable, JSON.stringify(o.Horarios)), (i = !0))
                            : ($("#hora_cita option").remove(), $("#hora_cita").append($("<option></option>").attr("value", "").text("Horas no disponibles")));
                },
                error: function (o, a, e) {
                    console.log(e), $(".overlay_loading").css("display", "none");
                },
            }),
            i
        );
    }
}
function buscarHorarioMKTenSis(o, a) {
    (a = a.replace(" ", "")),
        null != o &&
            o.length > 0 &&
            o.map(function (o) {
                o.Hora.split("-")[0] == a && ((configCovid.idHoraSis = o.Id), (configCovid.textHoraSis = o.Hora.split("-")[0]));
            });
}
function validarHorariosEnSis(o, a) {
    var e = !1;
    return (
        (a = a.replace(" ", "")),
        null != o &&
            o.length > 0 &&
            o.map(function (o) {
                o.Hora.split("-")[0] == a && (e = !0);
            }),
        e
    );
}

function creaJsonPagoEfectivo() {

    var IdClinica = parseInt($("#clinica_cita").val());
    var IdFormatoCorreo = 27;
    if (IdClinica == 1 || 
        IdClinica == 41 ||
        //IdClinica == 163 ||
        IdClinica == 109 ||
        IdClinica == 5 ||
        IdClinica == 6 || //Termina Sinaloa
        IdClinica == 148 ||
        IdClinica == 46 ||
        IdClinica == 96 ||
        IdClinica == 76 ||
        IdClinica == 79 || //Termina Ciudad de mexico
        IdClinica == 89 ||
        IdClinica == 68 ||
        IdClinica == 98 ||
        IdClinica == 153 ||
        IdClinica == 81 ||
        IdClinica == 87 ||
        IdClinica == 111 ||
        IdClinica == 102 ||
        IdClinica == 88 ||
        IdClinica == 73 ||
        IdClinica == 59 || //Termina Estado de Mexico
        IdClinica == 133) { //Termina Hidalgo
        IdFormatoCorreo = 52;
    }

    var RespCalle = "";
    if ( $("#colonia_cita option:selected").val() != "0" ) { RespCalle += "Col. " + $("#colonia_cita option:selected").text().toLowerCase(); }
    else{ RespCalle += "Col. no definida" }
    if ( $(".calle_cita").val() != "default" )
    { 
        RespCalle += " Calle " + $(".calle_cita").val();
        if($("#numero_casa_cita ").val() != "000"){
            RespCalle += " #" + $("#numero_casa_cita ").val();
        }
        else{
            RespCalle += " S/N";
        }
    }

    return {
        pacienteEstudios: {
            idPaciente: 0,
            IdSexo: 0,
            Materno: "",
            Nombre: "",
            Paterno: "",
            Sexo: 0,
            TelefonoCelular: "",
            IdEstado: 0,
            EstadoVal: "",
            IdCiudad: 0,
            CiudadVal: "",
            IdSucursal: 0,
            SucursalVal: "",
            CorreoElectronico: "",
            FechaNacimiento: "",
            Captcha: "",
            RecibirPromociones: !1,
            EsNuevo: !1,
            Existe: !1,
            IdPacSis: 0,
            IdSession: "",
            FechaCita: "",
            IdHorarioCita: "",
            HorarioCitaVal: "",
            IdSubestudio: 2402,
            SubestudioVal: "",
            IdUsuario: 3373,
            IdCitaSisPrev: 0,
            IdPacienteSisPrev: 0,
            Estudios: configCovid.arregloEstudios/*[
                {
                    Fecha: $("#fecha_cita").val(),
                    Hora: configCovid.textHoraSis,
                    HoraMKT: $("#hora_cita option:selected").html(),
                    IdHora: configCovid.idHoraSis,
                    IdHoraMKT: $("#hora_cita").val(),
                    Id: configCovid.jsonEstudio.Id,
                    IdEstudio: configCovid.jsonEstudio.EstudioID,
                    Nombre: configCovid.jsonEstudio.Estudio,
                    Descripcion: configCovid.jsonEstudio.Descripcion,
                    Precio: parseInt(configCovid.jsonEstudio.Precio),
                    Cantidad: 1,
                    Preparacion: configCovid.jsonEstudio.Preparacion,
                    EstatusDescuento: !1,
                    IdPaquete: 0,
                    NombrePaquete: "",
                },
            ]*/,
            IdFormatoCorreo: incluyePaquete ? 40 : IdFormatoCorreo,
            Domicilio: "",
            Telefonos: "",
            AsuntoCorreo: "Te has registrado correctamente",
            UrlCancelacion: "",
            OrigenCita: 9,
            TextoDeSuma: "",
            Folio: 0,
            EstatusLaboratorio: !1,
            CondicionFolios: 0,
            Vigencia: "",
            HorarioLaboratorio: "",
            TE: !1,
        },
        datosPaciente: {
            Id: configCovid.idPaciente,
            Nombre: EliminarAcentos($("#nombre_paciente_cita").val()),
            Paterno: EliminarAcentos($("#apellidop_paciente_cita").val()),
            Materno: EliminarAcentos($("#apellidom_paciente_cita").val()),
            Sexo: $("#form1 .fila .caja-radio input[name='genero']:checked").val(),
            FechaNacimiento: $("#fechanac_paciente_cita").val(),
            EstadoCivil: $("#estado_civil_cita").val(),
            CodigoPostal: $("#codigo_postal_cita").val(),
            IdColonia: $("#colonia_cita").val(),
            IdMunicipio: $("#MunicipioPaciente").val(),
            SeguridadSocial: SeguridadSocial(),
            Direccion: RespCalle,
            CentroTrabajo: "",
            Area: "",
            Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
            TelefonoCelular: $("#tel")
                .val()
                .replace(/[^0-9]/g, ""),
            FechaRegistro: "",
            FechaUltimoBloqueo: "",
            Estatus: 0,
            IdPacienteCitas: 0,
            GuardadoParcial: 0,
            IdSesion: "default",
            IdSucursal: $("#clinica_cita").val(),
            TipoPago: 2,
            IdIntento: configCovid.idIntento,
            TipoLanding: 1,
            Empresa: "",
        },
        DatosPago: { conektaTokenId: "", Nombre: "", Precio: 0, Correo: "", Telefono: "", Referencia: "", Token: "" },
    };
}
function GuardarCitaEfectivo() {
    /* Agregar cambio desde aqui para el nuevo paquete */
    configCovid.arregloEstudios = [];
    configCovid.arregloEstudios.push({
        Fecha: $("#fecha_cita").val(),
        Hora: configCovid.textHoraSis,
        HoraMKT: $("#hora_cita option:selected").html(),
        IdHora: configCovid.idHoraSis,
        IdHoraMKT: $("#hora_cita").val(),
        Id: configCovid.jsonEstudio.Id,
        IdEstudio: configCovid.jsonEstudio.EstudioID,
        Nombre: configCovid.jsonEstudio.Estudio,
        Descripcion: configCovid.jsonEstudio.Descripcion,
        Precio: parseFloat(configCovid.jsonEstudio.Precio),
        PrecioIVA: parseInt(configCovid.jsonEstudio.Precio) - parseInt(configCovid.jsonEstudio.PrecioBase),
        IVA: parseInt(configCovid.jsonEstudio.IVA),
        Cantidad: 1,
        Preparacion: configCovid.jsonEstudio.Preparacion,
        EstatusDescuento: !1,
        IdPaquete: 0,
        NombrePaquete: "",
    });

    if(incluyePaquete){
        for (var i = 0; i < jsonPaqueteNuevo.length; i++){
            configCovid.arregloEstudios.push({
                Fecha: $("#fecha_cita").val(),
                Hora: configCovid.textHoraSis,
                HoraMKT: $("#hora_cita option:selected").html(),
                IdHora: configCovid.idHoraSis,
                IdHoraMKT: $("#hora_cita").val(),
                Id: jsonPaqueteNuevo[i].Id,
                IdEstudio: configCovid.jsonEstudio.EstudioID,
                Nombre: jsonPaqueteNuevo[i].EstudioText,
                Descripcion: jsonPaqueteNuevo[i].Nombre,
                Precio: parseFloat(jsonPaqueteNuevo[i].Precio),
                PrecioIVA: parseFloat(jsonPaqueteNuevo[i].Precio - (jsonPaqueteNuevo[i].Precio / 1.16)),
                IVA: parseInt(configCovid.jsonEstudio.IVA),
                Cantidad: 1,
                Preparacion: jsonPaqueteNuevo[i].Preparacion,
                EstatusDescuento: !1,
                IdPaquete: jsonPaqueteNuevo[i].IdPaquete,
                NombrePaquete: jsonPaqueteNuevo[i].NombrePaquete,
            })
        }
    }

    var o = creaJsonPagoEfectivo();
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/GuardarCita",
        async: !1,
        data: o,
        dataType: "json",
        success: function (o) {
            if (o.IdCitaPaquete != 0){
                // $(".datos-pacientes .dato-folio-paquete").html(o.IdCitaPaquete);
                // $(".folio-paquete").show();
              }
            console.log(o),
                1 == o.status
                    ? ($(".datos-pacientes .nombre-cita-paciente").html($("#nombre_paciente_cita").val()),
                      $(".datos-pacientes .nombre-cita-clinica").html($("#clinica_cita option:selected").html()),
                      $(".datos-pacientes .dato-nombre").html($("#nombre_paciente_cita").val() + " " + $("#apellidop_paciente_cita").val() + " " + $("#apellidom_paciente_cita").val()),
                      $(".datos-pacientes .dato-folio").html(o.IdCita),
                      $(".datos-pacientes .dato-toma-muestra").html(o.Consultorio),
                      $(".datos-pacientes .dato-clinica").html($("#clinica_cita option:selected").html()),
                      $(".datos-pacientes .dato-fecha").html($("#fecha_cita").val()),
                      $(".datos-pacientes .dato-hora").html($("#hora_cita option:selected").html()),
                      $("#codigoQR").attr("src", generarCodigoQR(o.IdCita)),
                      (BanderaRecarga += 1),
                      mostrarExito(2),
                      configCovid.Folio = o.IdCita,
                      ActualizarFlagCuestionario())
                    : 2 == o.status
                    ? ($(".ErrorPagoClinica").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : 3 == o.status
                    ? ($(".ErrorPagoClinica").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : 4 == o.status
                    ? ($(".ErrorPagoClinica").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : 5 == o.status
                    ? ($(".ErrorPagoClinica").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : 6 == o.status
                    ? ($(".ErrorPagoClinica").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : ($(".procesando_datos").hide(), $("#form4").show());
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
// aqui
function creaJsonPagoOxxo() {

    var IdClinica = parseInt($("#clinica_cita").val());
    var IdFormatoCorreo = 45;
    if (IdClinica == 1 || 
        IdClinica == 41 ||
        //IdClinica == 163 ||
        IdClinica == 109 ||
        IdClinica == 5 ||
        IdClinica == 6 || //Termina Sinaloa
        IdClinica == 148 ||
        IdClinica == 46 ||
        IdClinica == 96 ||
        IdClinica == 76 ||
        IdClinica == 79 || //Termina Ciudad de mexico
        IdClinica == 89 ||
        IdClinica == 68 ||
        IdClinica == 98 ||
        IdClinica == 153 ||
        IdClinica == 81 ||
        IdClinica == 87 ||
        IdClinica == 111 ||
        IdClinica == 102 ||
        IdClinica == 88 ||
        IdClinica == 73 ||
        IdClinica == 59 || //Termina Estado de Mexico
        IdClinica == 133) { //Termina Hidalgo
        IdFormatoCorreo = 54;
    }

    var RespCalle = "";
    if ( $("#colonia_cita option:selected").val() != "0" ) { RespCalle += "Col. " + $("#colonia_cita option:selected").text().toLowerCase(); }
    else{ RespCalle += "Col. no definida" }
    if ( $(".calle_cita").val() != "default" )
    { 
        RespCalle += " Calle " + $(".calle_cita").val();
        if($("#numero_casa_cita ").val() != "000"){
            RespCalle += " #" + $("#numero_casa_cita ").val();
        }
        else{
            RespCalle += " S/N";
        }
    }

    return {
        pacienteEstudios: {
            idPaciente: 0,
            IdSexo: 0,
            Materno: "",
            Nombre: "",
            Paterno: "",
            Sexo: 0,
            TelefonoCelular: "",
            IdEstado: 0,
            EstadoVal: "",
            IdCiudad: 0,
            CiudadVal: "",
            IdSucursal: 0,
            SucursalVal: "",
            CorreoElectronico: "",
            FechaNacimiento: "",
            Captcha: "",
            RecibirPromociones: !1,
            EsNuevo: !1,
            Existe: !1,
            IdPacSis: 0,
            IdSession: "",
            FechaCita: "",
            IdHorarioCita: "",
            HorarioCitaVal: "",
            IdSubestudio: 2402,
            SubestudioVal: "",
            IdUsuario: 3373,
            IdCitaSisPrev: 0,
            IdPacienteSisPrev: 0,
            Estudios: configCovid.arregloEstudios/*[
                {
                    Fecha: $("#fecha_cita").val(),
                    Hora: configCovid.textHoraSis,
                    HoraMKT: $("#hora_cita option:selected").html(),
                    IdHora: configCovid.idHoraSis,
                    IdHoraMKT: $("#hora_cita").val(),
                    Id: configCovid.jsonEstudio.Id,
                    IdEstudio: configCovid.jsonEstudio.EstudioID,
                    Nombre: configCovid.jsonEstudio.Estudio,
                    Descripcion: configCovid.jsonEstudio.Descripcion,
                    Precio: parseInt(configCovid.jsonEstudio.Precio),
                    Cantidad: 1,
                    Preparacion: configCovid.jsonEstudio.Preparacion,
                    EstatusDescuento: !1,
                    IdPaquete: 0,
                    NombrePaquete: "",
                },
            ]*/,
            //IdFormatoCorreo: incluyePaquete ? 40 : 27, //pendiente
            IdFormatoCorreo: IdFormatoCorreo,
            Domicilio: "",
            Telefonos: "",
            AsuntoCorreo: "Has solicitado el pago de tu prueba COVID PCR mediante Oxxo Pay",
            UrlCancelacion: "",
            OrigenCita: 9,
            TextoDeSuma: "",
            Folio: 0,
            EstatusLaboratorio: !1,
            CondicionFolios: 0,
            Vigencia: "",
            HorarioLaboratorio: "",
            TE: !1,
        },
        datosPaciente: {
            Id: configCovid.idPaciente,
            Nombre: EliminarAcentos($("#nombre_paciente_cita").val()),
            Paterno: EliminarAcentos($("#apellidop_paciente_cita").val()),
            Materno: EliminarAcentos($("#apellidom_paciente_cita").val()),
            Sexo: $("#form1 .fila .caja-radio input[name='genero']:checked").val(),
            FechaNacimiento: $("#fechanac_paciente_cita").val(),
            EstadoCivil: $("#estado_civil_cita").val(),
            CodigoPostal: $("#codigo_postal_cita").val(),
            IdColonia: $("#colonia_cita").val(),
            IdMunicipio: $("#MunicipioPaciente").val(),
            SeguridadSocial: SeguridadSocial(),
            Direccion: RespCalle,
            CentroTrabajo: "",
            Area: "",
            Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
            TelefonoCelular: $("#tel")
                .val()
                .replace(/[^0-9]/g, ""),
            FechaRegistro: "",
            FechaUltimoBloqueo: "",
            Estatus: 0,
            IdPacienteCitas: 0,
            GuardadoParcial: 0,
            IdSesion: "default",
            IdSucursal: $("#clinica_cita").val(),
            TipoPago: 4,
            IdIntento: configCovid.idIntento,
            TipoLanding: 1,
            Empresa: "",
        },
        DatosPago: { conektaTokenId: "", Nombre: "", Precio: 0, Correo: "", Telefono: "", Referencia: "", Token: "" },
    };
}
function GuardarCitaOxxo() {
    configCovid.arregloEstudios = [];
    configCovid.arregloEstudios.push({
        Fecha: $("#fecha_cita").val(),
        Hora: configCovid.textHoraSis,
        HoraMKT: $("#hora_cita option:selected").html(),
        IdHora: configCovid.idHoraSis,
        IdHoraMKT: $("#hora_cita").val(),
        Id: configCovid.jsonEstudio.Id,
        IdEstudio: configCovid.jsonEstudio.EstudioID,
        Nombre: configCovid.jsonEstudio.Estudio,
        Descripcion: configCovid.jsonEstudio.Descripcion,
        Precio: parseFloat(configCovid.jsonEstudio.Precio),
        PrecioIVA: parseInt(configCovid.jsonEstudio.Precio) - parseInt(configCovid.jsonEstudio.PrecioBase),
        IVA: parseInt(configCovid.jsonEstudio.IVA),
        Cantidad: 1,
        Preparacion: configCovid.jsonEstudio.Preparacion,
        EstatusDescuento: !1,
        IdPaquete: 0,
        NombrePaquete: "",
    });

    /*
    if(incluyePaquete){
        for (var i = 0; i < jsonPaqueteNuevo.length; i++){
            configCovid.arregloEstudios.push({
                Fecha: $("#fecha_cita").val(),
                Hora: configCovid.textHoraSis,
                HoraMKT: $("#hora_cita option:selected").html(),
                IdHora: configCovid.idHoraSis,
                IdHoraMKT: $("#hora_cita").val(),
                Id: jsonPaqueteNuevo[i].Id,
                IdEstudio: configCovid.jsonEstudio.EstudioID,
                Nombre: jsonPaqueteNuevo[i].EstudioText,
                Descripcion: jsonPaqueteNuevo[i].Nombre,
                Precio: parseFloat(jsonPaqueteNuevo[i].Precio),
                PrecioIVA: parseFloat(jsonPaqueteNuevo[i].Precio - (jsonPaqueteNuevo[i].Precio / 1.16)),
                IVA: parseInt(configCovid.jsonEstudio.IVA),
                Cantidad: 1,
                Preparacion: jsonPaqueteNuevo[i].Preparacion,
                EstatusDescuento: !1,
                IdPaquete: jsonPaqueteNuevo[i].IdPaquete,
                NombrePaquete: jsonPaqueteNuevo[i].NombrePaquete,
            })
        }
    }*/

    var o = creaJsonPagoOxxo();
    var lista_referencia_oxxo = new Array();
    
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/GuardarCita",
        async: !1,
        data: o,
        dataType: "json",
        success: function (o) {
            if (o.IdCitaPaquete != 0){
                // $(".datos-pacientes .dato-folio-paquete").html(o.IdCitaPaquete);
                // $(".folio-paquete").show();
              }
            console.log(o),
                1 == o.status
                    ? 
                    ($(".info-cita").hide(),
                    $(".comprobante-orden-oxxopay #ordenOxxoPayFecha").html(o.FechaOrdenOxxo),
                    //$(".comprobante-orden-oxxopay #ordenOxxoPayReferencia").html(o.ReferenciaOxxo),
                    //ReferenciaOxxo
                    lista_referencia_oxxo = o.ReferenciaOxxo.match(/.{1,4}/g),
                    lista_referencia_oxxo.forEach(function(item,index){
                        $("#divReferencia").append("<span>"+item+'</span>');
                    }),
                    //$("#divReferencia").append("<span>"+o.ReferenciaOxxo+'</span>'),
                    $(".comprobante-orden-oxxopay #ordenOxxoPayVigencia").html(o.VigenciaOxxoPay),
                    //$(".comprobante-orden-oxxopay .estudio-agregaddo").html(o.DescripcionEstudio),
                    $(".comprobante-orden-oxxopay .fecha-hora").html(o.FechaCita + " " + o.HoraCita),
                    $(".comprobante-orden-oxxopay .precio-estudio").html("$"+o.PrecioEstudio),
                    $(".comprobante-orden-oxxopay .sd-total-pago-linea").html("$"+o.Total),
                    //Nuevos datos OxxoPay Folio (o.IdCita)
                    $(".comprobante-orden-oxxopay #OxxoPayFolioCita").html(o.IdCita),
                    $("#OxxoPayClinica").text($(".clinica_cita option:selected").text()),
                    $("#OxxoPayFecha").html(o.FechaCita + " " + o.HoraCita),
                    $("#OxxoPayDireccion").html(o.ClinicaDomicilio.toLowerCase()),
                    $("#OxxoPayDireccion").css("text-transform","capitalize"),
                    $("#OxxoPayNombre").html(o.NombreNormal),
                      (BanderaRecarga += 1),
                      mostrarExito(4),
                      configCovid.Folio = o.IdCita,
                      ActualizarFlagCuestionario())
                    : 2 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 3 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 4 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 5 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 6 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : ($(".procesando_datos").hide(), $("#form4").show(), $("#contenedor-error-pago").text(o.error.message).show(), $("#continuar_4").prop("disabled", !1));

        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}


//aqui
function creaJsonPagoTarjeta(o) {

    var IdClinica = parseInt($("#clinica_cita").val());
    var IdFormatoCorreo = 28;
    if (IdClinica == 1 || 
        IdClinica == 41 ||
        //IdClinica == 163 ||
        IdClinica == 109 ||
        IdClinica == 5 ||
        IdClinica == 6 || //Termina Sinaloa
        IdClinica == 148 ||
        IdClinica == 46 ||
        IdClinica == 96 ||
        IdClinica == 76 ||
        IdClinica == 79 || //Termina Ciudad de mexico
        IdClinica == 89 ||
        IdClinica == 68 ||
        IdClinica == 98 ||
        IdClinica == 153 ||
        IdClinica == 81 ||
        IdClinica == 87 ||
        IdClinica == 111 ||
        IdClinica == 102 ||
        IdClinica == 88 ||
        IdClinica == 73 ||
        IdClinica == 59 || //Termina Estado de Mexico
        IdClinica == 133) { //Termina Hidalgo
        IdFormatoCorreo = 53;
    }

    var RespCalle = "";
    if ( $("#colonia_cita option:selected").val() != "0" ) { RespCalle += "Col. " + $("#colonia_cita option:selected").text().toLowerCase(); }
    else{ RespCalle += "Col. no definida" }
    if ( $(".calle_cita").val() != "default" )
    { 
        RespCalle += " Calle " + $(".calle_cita").val();
        if($("#numero_casa_cita ").val() != "000"){
            RespCalle += " #" + $("#numero_casa_cita ").val();
        }
        else{
            RespCalle += " S/N";
        }
    }

    return {
        pacienteEstudios: {
            idPaciente: 0,
            IdSexo: 0,
            Materno: "",
            Nombre: "",
            Paterno: "",
            Sexo: 0,
            TelefonoCelular: "",
            IdEstado: 0,
            EstadoVal: "",
            IdCiudad: 0,
            CiudadVal: "",
            IdSucursal: 0,
            SucursalVal: "",
            CorreoElectronico: "",
            FechaNacimiento: "",
            Captcha: "",
            RecibirPromociones: !1,
            EsNuevo: !1,
            Existe: !1,
            IdPacSis: 0,
            IdSession: "",
            FechaCita: "",
            IdHorarioCita: "",
            HorarioCitaVal: "",
            IdSubestudio: 2402,
            SubestudioVal: "",
            IdUsuario: 3373,
            IdCitaSisPrev: 0,
            IdPacienteSisPrev: 0,
            Estudios: configCovid.arregloEstudios/*[
                {
                    Fecha: $("#fecha_cita").val(),
                    Hora: configCovid.textHoraSis,
                    HoraMKT: $("#hora_cita option:selected").html(),
                    IdHora: configCovid.idHoraSis,
                    IdHoraMKT: $("#hora_cita").val(),
                    Id: configCovid.jsonEstudio.Id,
                    IdEstudio: configCovid.jsonEstudio.EstudioID,
                    Nombre: configCovid.jsonEstudio.Estudio,
                    Descripcion: configCovid.jsonEstudio.Descripcion,
                    Precio: parseInt(configCovid.jsonEstudio.Precio),
                    Cantidad: 1,
                    Preparacion: configCovid.jsonEstudio.Preparacion,
                    EstatusDescuento: !1,
                    IdPaquete: 0,
                    NombrePaquete: "",
                },
            ]*/,
            IdFormatoCorreo: incluyePaquete ? 40 : IdFormatoCorreo,
            Domicilio: "",
            Telefonos: "",
            AsuntoCorreo: "Te has registrado correctamente",
            UrlCancelacion: "",
            OrigenCita: 9,
            TextoDeSuma: "",
            Folio: 0,
            EstatusLaboratorio: !1,
            CondicionFolios: 0,
            Vigencia: "",
            HorarioLaboratorio: "",
            TE: !1,
        },
        datosPaciente: {
            Id: configCovid.idPaciente,
            Nombre: EliminarAcentos($("#nombre_paciente_cita").val()),
            Paterno: EliminarAcentos($("#apellidop_paciente_cita").val()),
            Materno: EliminarAcentos($("#apellidom_paciente_cita").val()),
            Sexo: $("#form1 .fila .caja-radio input[name='genero']:checked").val(),
            FechaNacimiento: $("#fechanac_paciente_cita").val(),
            EstadoCivil: $("#estado_civil_cita").val(),
            CodigoPostal: $("#codigo_postal_cita").val(),
            IdColonia: $("#colonia_cita").val(),
            IdMunicipio: $("#MunicipioPaciente").val(),
            SeguridadSocial: SeguridadSocial(),
            Direccion: RespCalle,
            CentroTrabajo: "",
            Area: "",
            Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
            TelefonoCelular: $("#tel")
                .val()
                .replace(/[^0-9]/g, ""),
            FechaRegistro: "",
            FechaUltimoBloqueo: "",
            Estatus: 0,
            IdPacienteCitas: 0,
            GuardadoParcial: 0,
            IdSesion: "default",
            IdSucursal: $("#clinica_cita").val(),
            TipoPago: 3,
            IdIntento: configCovid.idIntento,
            TipoLanding: 1,
            Empresa: "",
        },
        DatosPago: {
            conektaTokenId: "",
            Nombre: $("#nombre-titular").val(),
            Precio: 0,
            Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
            Telefono: $("#tel")
                .val()
                .replace(/[^0-9]/g, ""),
            Referencia: "",
            Pan: $("#numero-tarjeta").val(),
            cvv2: $("#numero-cvv").val(),
            expDate: $("#fecha-vencimiento-anio").val().slice(-2) + $("#fecha-vencimiento-mes").val(),
        },
    };
}
function GuardarCitaTarjeta() {
    /* Agregar cambio desde aqui para el nuevo paquete */
    configCovid.arregloEstudios = [];
    configCovid.arregloEstudios.push({
        Fecha: $("#fecha_cita").val(),
        Hora: configCovid.textHoraSis,
        HoraMKT: $("#hora_cita option:selected").html(),
        IdHora: configCovid.idHoraSis,
        IdHoraMKT: $("#hora_cita").val(),
        Id: configCovid.jsonEstudio.Id,
        IdEstudio: configCovid.jsonEstudio.EstudioID,
        Nombre: configCovid.jsonEstudio.Estudio,
        Descripcion: configCovid.jsonEstudio.Descripcion,
        Precio: parseFloat(configCovid.jsonEstudio.Precio),
        PrecioIVA: parseInt(configCovid.jsonEstudio.Precio) - parseInt(configCovid.jsonEstudio.PrecioBase),
        IVA: parseInt(configCovid.jsonEstudio.IVA),
        Cantidad: 1,
        Preparacion: configCovid.jsonEstudio.Preparacion,
        EstatusDescuento: !1,
        IdPaquete: 0,
        NombrePaquete: "",
    });

    if(incluyePaquete){
        for (var i = 0; i < jsonPaqueteNuevo.length; i++){
            configCovid.arregloEstudios.push({
                Fecha: $("#fecha_cita").val(),
                Hora: configCovid.textHoraSis,
                HoraMKT: $("#hora_cita option:selected").html(),
                IdHora: configCovid.idHoraSis,
                IdHoraMKT: $("#hora_cita").val(),
                Id: jsonPaqueteNuevo[i].Id,
                IdEstudio: configCovid.jsonEstudio.EstudioID,
                Nombre: jsonPaqueteNuevo[i].EstudioText,
                Descripcion: jsonPaqueteNuevo[i].Nombre,
                Precio: parseFloat(jsonPaqueteNuevo[i].Precio),
                PrecioIVA: parseFloat(jsonPaqueteNuevo[i].Precio - (jsonPaqueteNuevo[i].Precio / 1.16)),
                IVA: parseInt(configCovid.jsonEstudio.IVA),
                Cantidad: 1,
                Preparacion: jsonPaqueteNuevo[i].Preparacion,
                EstatusDescuento: !1,
                IdPaquete: jsonPaqueteNuevo[i].IdPaquete,
                NombrePaquete: jsonPaqueteNuevo[i].NombrePaquete,
            })
        }
    }
    var a = creaJsonPagoTarjeta();
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/GuardarCita",
        async: !1,
        data: a,
        dataType: "json",
        success: function (o) {
            if ((console.log(o), 1 == o.status)) {
                if (o.IdCitaPaquete != 0){
                    // $(".datos-pacientes .dato-folio-paquete").html(o.IdCitaPaquete);
                    // $(".folio-paquete").show();
                      }
                $(".datos-pacientes .nombre-cita-paciente").html($("#nombre_paciente_cita").val()),
                    $(".datos-pacientes .nombre-cita-clinica").html($("#clinica_cita option:selected").html()),
                    $(".datos-pacientes .dato-nombre").html($("#nombre_paciente_cita").val() + " " + $("#apellidop_paciente_cita").val() + " " + $("#apellidom_paciente_cita").val()),
                    $(".datos-pacientes .dato-folio").html(o.IdCita),
                    $("#codigoQR").attr("src", generarCodigoQR(o.IdCita)),
                    $(".datos-pacientes .dato-toma-muestra").html(o.Consultorio),
                    $(".datos-pacientes .dato-clinica").html($("#clinica_cita option:selected").html()),
                    $(".datos-pacientes .dato-fecha").html($("#fecha_cita").val()),
                    $(".datos-pacientes .dato-hora").html($("#hora_cita option:selected").html()),
                    $(".datos-pago .datos-tarjeta-pago .referencia span").html(o.responsePago.authNumber),
                    $(".datos-pago .datos-tarjeta-pago .fecha-pago span").html(o.DetallePago.FechaActual),
                    $(".datos-pago .datos-tarjeta-pago .medio-pago span").html(o.DetallePago.TipoTarjeta),
                    $(".datos-pago .datos-tarjeta-pago .num-tarjeta span").html(o.DetallePago.NumTarjeta);
                var a = "$" + o.responsePago.amount + ".00";
                $(".datos-pago .totales-pago > .total-numero .total-numero").html(a), (BanderaRecarga += 1), mostrarExito(3), 
                configCovid.Folio = o.IdCita, 
                ActualizarFlagCuestionario();
            } else
                2 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 3 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 4 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 5 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1))
                    : 6 == o.status
                    ? ($("#contenedor-error-pago").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show())
                    : ($(".procesando_datos").hide(), $("#form4").show(), $("#contenedor-error-pago").text(o.error.message).show(), $("#continuar_4").prop("disabled", !1));
        },
        error: function (o, a, e) {
            $("#contenedor-error-pago").text("Tarjeta rechazada por el banco emisor. Intenta nuevamente con otra tarjeta o ponte en contacto con tu banco para más información. Recuerda que puedes seleccionar otro método de pago.").show(),
            console.log(e), $(".procesando_datos").hide(), $("#form4").show(), $("#continuar_4").prop("disabled", !1).css("background-color", "#0074d9");
        },
    });
}
function mostrarPaginaCargando() {
    ScrollTop(), $("form").hide(), $(".procesando_datos").show();
}
function mostrarExito(o) {
        ScrollTop(),
        $(".formulario .form-content").hide(),
        $(".form-exitoso").show(),
        setTimeout(function () {
            $(".form-exitoso .registro").hide(),
            3 == o ? $(".datos-pago").show() : $(".datos-pago").hide(),
            4 == o ? $(".comprobante-orden-oxxopay").show() : $(".comprobante-orden-oxxopay").hide(),
            $(".form-exitoso .datos-pacientes").show();
        }, 5e3);
        var IdSucursal = parseInt(app.IdSucursal);
        $("#resultadosCategoriaA").css("display", "none");
        $("#resultadosCategoriaB").css("display", "none");
        $("#resultadosCategoriaC").css("display", "none");
        var categoria = 3;
        /*switch (IdSucursal) {
            case 148:
            case 89:
            case 68:
            case 98:
            case 46:
            case 96:
            case 1:
            case 41:
            case 163:
            case 109:
            case 153:
            case 111:
            case 81:
            case 76:
            case 87:
            case 102:
            case 88:
            case 73:
            case 79:
            case 59:
                categoria = 1;
                break;
            case 143:
            case 56:
            case 40:
            case 5:
            case 6:
            case 9:
            case 165:
            case 133:
            case 33:
            case 139:
            case 12:
            case 159:
            case 37:
                categoria = 2;
                break;
        }*/
        if(categoria == 1){
            $("#resultadosCategoriaA").css("display", "block");
        }
        else if(categoria == 2){
            $("#resultadosCategoriaB").css("display", "block");
        }
        else{
            $("#resultadosCategoriaC").css("display", "block");
        }
}
function ActualizarIntento() {
    var o;
    (o = crearJsonRespuestas()),
        $.ajax({
            type: "POST",
            url: configCovid.urlCovid + "ActualizarIntento",
            async: !1,
            data: o,
            dataType: "json",
            success: function (o) {
                //ActualizarFlagCuestionario(configCovid.IdFolio);
                //mostrarExito(o);
                console.log("Respuestas Guardadas");
            },
            error: function (o, a, e) {
                console.log(e);
            },
        });
}
function GenerarTokenPago(o) {
    var a = o;
    return Conekta.Token.create(a, conektaSuccessResponseHandler, conektaErrorResponseHandler), !1;
}
$(document).ready(function () {
    var cargar_coppelpay = 0;
    $("#continuar_1").click(function () {
        var o = $("#tel")
            .val()
            .replace(/[^0-9]/g, "")
            .trim();
        validarPaciente($("#correo").val().trim(), o);
    }),
        $("#continuar_2").click(function () {
            pasarPaso3();
        }),
        $("#continuar_3").click(function () {
            guardarIntento();
            $("#continuar_4").prop("disabled", !0).css("background-color", "#e5e5e5");
        }),
        $(".editar-datos").click(function () {
            regresarDatosPaciente();
        }),
        $(".SiCronometro").click(function () {
            if(reiniciarCronometro == 0){
                toMinute = 8; toSecond = 0; BanderaRecordatorio = 0;

                $.ajax({
                    type: "POST",
                    url: "https://servicios.salud-digna.org/horarios/pcr/bloquear",
                    async: !1,
                    dataType: "json",
                    data: { idHorario: parseInt($(".hora_cita option:selected").val()), time: 8 },
                    success: function (o) {
                    },
                    error: function (o, a, e) {
                        console.log(e + " -  Error al apartar horario");
                    },
                });
                reiniciarCronometro++;
            }
        }),
        $("#form4 #metodo_pago .caja-radio input[name='pago']").click(function () {
            //Pago en clinica (form_pago_en_clinica)
            2 == $(this).val()
                ? ($("#form_pago_en_clinica").slideDown("slow"), $("#continuar_4").attr("disabled", !1).css("background-color", "#0074d9"))
                : ($("#form_pago_en_clinica").slideUp("slow"));
            //Pago en linea (form_pago_en_linea)
            3 == $(this).val()
                ? ($("#form_pago_en_linea").slideDown("slow"), $("#continuar_4").attr("disabled", !0).css("background-color", "#e5e5e5"))
                : $("#form_pago_en_linea").slideUp("slow");
            //Pago en oxxo
            4 == $(this).val()
                ? ($(".MensajePagoOxxo").slideDown("slow"), $("#continuar_4").attr("disabled", !1).css("background-color", "#0074d9"))
                : ($(".MensajePagoOxxo").slideUp("slow"));
            //Pago en Coppel (form_pago_coppel)
            5 == $(this).val()
                ? ($("#form_pago_coppel").slideDown("slow"), $("#continuar_4").attr("disabled", !0).css("background-color", "#e5e5e5"))
                : ($("#form_pago_coppel").slideUp("slow"));

            if(cargar_coppelpay == 0 && $(this).val() == 5){
                setTimeout(function(){
                    inicializarCPLPY($("#clinica_cita").val(), encodeURIComponent(configCovid.idIntento), configCovid.jsonEstudio.Precio);
                    cargar_coppelpay = 1;
                }, 1000);
            }
        }),
        $("#continuar_4").on("click", function () {
            var o = $("#form4 #metodo_pago .caja-radio input[name='pago']:checked").val();

            clearInterval(Temporizador);
            $(".ContadorCita").slideUp("slow");
            
            return (
                $("#form4").hide(),
                    "2" == o
                    ? $('#continuar_6').trigger('click') //($("#form6").show(), !1)
                    : "3" == o
                    ? $('#continuar_5').trigger('click') //($("#form5").show(), !1)
                    : "4" == o
                    ? $('#continuar_8 ').trigger('click') //($("#formOxxo").show(), !1)
                    : "5" == o
                    ? $('#continuar_7').trigger('click') //($(this).attr("disabled", "true").css("background-color", "#e5e5e5"), inicializarCPLPY($("#clinica_cita").val(), encodeURIComponent(configCovid.idIntento)), !1)
                    : void 0
            );
        }),
        $("#continuar_5").click(function () {
            $(this).prop("disabled", !0).css("background-color", "#e5e5e5"), 
            //GenerarTokenPago($("#contenedor-datos-tarjeta")); //Pago con conekta

            /* comienza Billpocket */
            mostrarPaginaCargando();
            $('html, body').animate({ scrollTop: $(".formulario").offset().top - 150 }, 1500);
            setTimeout(function () {
                GuardarCitaTarjeta(); 
            }, 1e3);
            setTimeout(function () {
                guardarBitacora(3);
            }, 1e3);
            /* termina */
        }),
        $("#continuar_6").click(function () {
            mostrarPaginaCargando(),
            $('html, body').animate({ scrollTop: $(".formulario").offset().top - 150 }, 1500),
                setTimeout(function () {
                    GuardarCitaEfectivo();
                }, 1e3);
                setTimeout(function () {
                    guardarBitacora(2); 
                }, 1e3);
        }),
        $("#continuar_8").click(function () {
            mostrarPaginaCargando(),
            $('html, body').animate({ scrollTop: $(".formulario").offset().top - 150 }, 1500),
                setTimeout(function () {
                    GuardarCitaOxxo();
                }, 1e3);
                setTimeout(function () {
                    guardarBitacora(4);
                }, 1e3);
        }),
        $("#continuar_7").click(function () {
            void 0 !== CPLPY.blackbox && null != CPLPY.blackbox && "" != CPLPY.blackbox
                ? ($("#contenedor-error-pago-CPLPY").hide(),
                  mostrarPaginaCargando(),
                  $('html, body').animate({ scrollTop: $(".formulario").offset().top - 150 }, 1500),
                  setTimeout(function () {
                      GuardarCitaCoppelPay();
                  }, 1e3),
                  setTimeout(function () {
                    guardarBitacora(5);
                }, 1e3))
                  
                : ($("#contenedor-error-pago-CPLPY").text("Debe de iniciar sesión con su usuario de Coppel para continuar.").slideDown(),
                  $(".procesando_datos").hide(),
                  $("#form4").show(),
                  $("#form4 > div").animate({ scrollTop: 5e3 }, 500));
        });
}),
    Conekta.setPublicKey("key_fNdPxbPkqAt1xF1sYMgQF5w");
var conektaSuccessResponseHandler = function (o) {
        mostrarPaginaCargando(),
            setTimeout(function () {
                GuardarCitaTarjeta();
            }, 1e3);
            setTimeout(function () {
                guardarBitacora(3); 
            }, 1e3);
    },
    conektaErrorResponseHandler = function (o) {
        $(".errorinput").remove(), $("#contenedor-error-pago").hide(), $("#continuar_5").prop("disabled", !1).css("background-color", "#0074d9"), $("#contenedor-error-pago").text(o.message_to_purchaser).show().css("text-align", "center");
    };
function inicializarCPLPY(o, a, e) {
    $("#contenedor-error-form4").hide(),
    $(".overlay_loading").css("display", "flex"),
        $.ajax({
            type: "GET",
            url: "/inicializar-cplpy?sucursal=" + o + "&transacion=" + a + "&precio=" + e,
            async: 1,
            dataType: "json",
            contentType: "application/json",
            success: function (o) {
                1 == o.estatus
                    ? (coppelPay(o.data.cpl_business, o.data.cpl_transaction, o.data.cpl_signature, o.data.cpl_amount)) //$("#form7").show())
                    : ($("#contenedor-error-form4").text("Error al inicializar CoppelPay."), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500)),
                    $(".overlay_loading").css("display", "none"),
                    $("#continuar_4").attr("disabled", !1).css("background-color", "#0074d9");
            },
            error: function (o, a, e) {
                console.log(e),
                    $("#contenedor-error-form4").text("Error al inicializar CoppelPay."),
                    $("#form4").show(),
                    $("#form4 > div").animate({ scrollTop: 5e3 }, 500),
                    $(".overlay_loading").css("display", "none"),
                    $("#continuar_4").attr("disabled", !1).css("background-color", "#0074d9");
            },
        });
}
function coppelPay(o, a, e, t) {
    var i = { cpl_business: o, cpl_transaction: a, cpl_signature: e, cpl_amount: t, cpl_currency: "MXN", cpl_description: "Prueba COVID-19.", cpl_url_redirect: "http://beta2.salud-digna.org/" };
    $.ajax({
        type: "POST",
        url: "https://api.coppelpay.com/CoppelPay/solicitud-compra",
        async: 1,
        data: JSON.stringify(i),
        dataType: "json",
        contentType: "application/json",
        success: function (o) {
            "SUCCESS" == o.code
                ? (CPLPY.init(JSON.parse(o.data).solicitud),
                  (CPLPY.sandbox = !1),
                  CPLPY.open(),
                  $("#cpplPay").css({ width: "100%", "overflow-x": "scroll" }),
                  $("iframe").css({ height: "720px", width: "100%" }),
                  $(".LoaderCoppelPay").hide(),
                  (solicitud = JSON.parse(o.data).solicitud),
                  (blackbox = CPLPY.blackbox),
                  (token = CPLPY.token))
                : ($("#contenedor-error-pago-CPLPY").text(o.message).slideDown(), $(".LoaderCoppelPay").hide(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500), $(".overlay_loading").css("display", "none"));
        },
        error: function (o, a, e) {
            console.log(e),  $(".overlay_loading").css("display", "none"), $(".LoaderCoppelPay").hide(), $("#contenedor-error-pago-CPLPY").text("No se puede pagar con CoppelPay por el momento, intente más tarde.").slideDown(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500);
        },
    });
}
function creaJsonPagoCoppelPay() {

    var IdClinica = parseInt($("#clinica_cita").val());
    var IdFormatoCorreo = 28;
    if (IdClinica == 1 || 
        IdClinica == 41 ||
        //IdClinica == 163 ||
        IdClinica == 109 ||
        IdClinica == 5 ||
        IdClinica == 6 || //Termina Sinaloa
        IdClinica == 148 ||
        IdClinica == 46 ||
        IdClinica == 96 ||
        IdClinica == 76 ||
        IdClinica == 79 || //Termina Ciudad de mexico
        IdClinica == 89 ||
        IdClinica == 68 ||
        IdClinica == 98 ||
        IdClinica == 153 ||
        IdClinica == 81 ||
        IdClinica == 87 ||
        IdClinica == 111 ||
        IdClinica == 102 ||
        IdClinica == 88 ||
        IdClinica == 73 ||
        IdClinica == 59 || //Termina Estado de Mexico
        IdClinica == 133) { //Termina Hidalgo
        IdFormatoCorreo = 53;
    }

    var RespCalle = "";
    if ( $("#colonia_cita option:selected").val() != "0" ) { RespCalle += "Col. " + $("#colonia_cita option:selected").text().toLowerCase(); }
    else{ RespCalle += "Col. no definida" }
    if ( $(".calle_cita").val() != "default" )
    { 
        RespCalle += " Calle " + $(".calle_cita").val();
        if($("#numero_casa_cita ").val() != "000"){
            RespCalle += " #" + $("#numero_casa_cita ").val();
        }
        else{
            RespCalle += " S/N";
        }
    }

    if(IdClinica == 111) { IdFormatoCorreo = 57; } //Pastejé

    return {
        pacienteEstudios: {
            idPaciente: 0,
            IdSexo: 0,
            Materno: "",
            Nombre: "",
            Paterno: "",
            Sexo: 0,
            TelefonoCelular: "",
            IdEstado: 0,
            EstadoVal: "",
            IdCiudad: 0,
            CiudadVal: "",
            IdSucursal: 0,
            SucursalVal: "",
            CorreoElectronico: "",
            FechaNacimiento: "",
            Captcha: "",
            RecibirPromociones: !1,
            EsNuevo: !1,
            Existe: !1,
            IdPacSis: 0,
            IdSession: "",
            FechaCita: "",
            IdHorarioCita: "",
            HorarioCitaVal: "",
            IdSubestudio: 2402,
            SubestudioVal: "",
            IdUsuario: 3373,
            IdCitaSisPrev: 0,
            IdPacienteSisPrev: 0,
            Estudios: configCovid.arregloEstudios/*[
                {
                    Fecha: $("#fecha_cita").val(),
                    Hora: configCovid.textHoraSis,
                    HoraMKT: $("#hora_cita option:selected").html(),
                    IdHora: configCovid.idHoraSis,
                    IdHoraMKT: $("#hora_cita").val(),
                    Id: configCovid.jsonEstudio.Id,
                    IdEstudio: configCovid.jsonEstudio.EstudioID,
                    Nombre: configCovid.jsonEstudio.Estudio,
                    Descripcion: configCovid.jsonEstudio.Descripcion,
                    Precio: parseInt(configCovid.jsonEstudio.Precio),
                    Cantidad: 1,
                    Preparacion: configCovid.jsonEstudio.Preparacion,
                    EstatusDescuento: !1,
                    IdPaquete: 0,
                    NombrePaquete: "",
                },
            ]*/,
            IdFormatoCorreo: incluyePaquete ? 40 : IdFormatoCorreo,
            Domicilio: "",
            Telefonos: "",
            AsuntoCorreo: "Te has registrado correctamente",
            UrlCancelacion: "",
            OrigenCita: 9,
            TextoDeSuma: "",
            Folio: 0,
            EstatusLaboratorio: !1,
            CondicionFolios: 0,
            Vigencia: "",
            HorarioLaboratorio: "",
            TE: !1,
        },
        datosPaciente: {
            Id: configCovid.idPaciente,
            Nombre: EliminarAcentos($("#nombre_paciente_cita").val()),
            Paterno: EliminarAcentos($("#apellidop_paciente_cita").val()),
            Materno: EliminarAcentos($("#apellidom_paciente_cita").val()),
            Sexo: $("#form1 .fila .caja-radio input[name='genero']:checked").val(),
            FechaNacimiento: $("#fechanac_paciente_cita").val(),
            EstadoCivil: $("#estado_civil_cita").val(),
            CodigoPostal: $("#codigo_postal_cita").val(),
            IdColonia: $("#colonia_cita").val(),
            IdMunicipio: $("#MunicipioPaciente").val(),
            SeguridadSocial: SeguridadSocial(),
            Direccion: RespCalle,
            CentroTrabajo: "",
            Area: "",
            Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
            TelefonoCelular: $("#tel")
                .val()
                .replace(/[^0-9]/g, ""),
            FechaRegistro: "",
            FechaUltimoBloqueo: "",
            Estatus: 0,
            IdPacienteCitas: 0,
            GuardadoParcial: 0,
            IdSesion: "default",
            IdSucursal: $("#clinica_cita").val(),
            TipoPago: 5,
            IdIntento: configCovid.idIntento,
            TipoLanding: 1,
            Empresa: "",
        },
        DatosPago: { conektaTokenId: "", Nombre: "", Precio: 0, Correo: "", Telefono: "", Referencia: "", Token: "" },
    };
}
function GuardarCitaCoppelPay() {
    /* Agregar cambio desde aqui para el nuevo paquete */
    configCovid.arregloEstudios = [];
    configCovid.arregloEstudios.push({
        Fecha: $("#fecha_cita").val(),
        Hora: configCovid.textHoraSis,
        HoraMKT: $("#hora_cita option:selected").html(),
        IdHora: configCovid.idHoraSis,
        IdHoraMKT: $("#hora_cita").val(),
        Id: configCovid.jsonEstudio.Id,
        IdEstudio: configCovid.jsonEstudio.EstudioID,
        Nombre: configCovid.jsonEstudio.Estudio,
        Descripcion: configCovid.jsonEstudio.Descripcion,
        Precio: parseFloat(configCovid.jsonEstudio.Precio),
        PrecioIVA: parseInt(configCovid.jsonEstudio.Precio) - parseInt(configCovid.jsonEstudio.PrecioBase),
        IVA: parseInt(configCovid.jsonEstudio.IVA),
        Cantidad: 1,
        Preparacion: configCovid.jsonEstudio.Preparacion,
        EstatusDescuento: !1,
        IdPaquete: 0,
        NombrePaquete: "",
    });

    if(incluyePaquete){
        for (var i = 0; i < jsonPaqueteNuevo.length; i++){
            configCovid.arregloEstudios.push({
                Fecha: $("#fecha_cita").val(),
                Hora: configCovid.textHoraSis,
                HoraMKT: $("#hora_cita option:selected").html(),
                IdHora: configCovid.idHoraSis,
                IdHoraMKT: $("#hora_cita").val(),
                Id: jsonPaqueteNuevo[i].Id,
                IdEstudio: configCovid.jsonEstudio.EstudioID,
                Nombre: jsonPaqueteNuevo[i].EstudioText,
                Descripcion: jsonPaqueteNuevo[i].Nombre,
                Precio: parseFloat(jsonPaqueteNuevo[i].Precio),
                PrecioIVA: parseFloat(jsonPaqueteNuevo[i].Precio - (jsonPaqueteNuevo[i].Precio / 1.16)),
                IVA: parseInt(configCovid.jsonEstudio.IVA),
                Cantidad: 1,
                Preparacion: jsonPaqueteNuevo[i].Preparacion,
                EstatusDescuento: !1,
                IdPaquete: jsonPaqueteNuevo[i].IdPaquete,
                NombrePaquete: jsonPaqueteNuevo[i].NombrePaquete,
            })
        }
    }
    var o = creaJsonPagoCoppelPay();
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/GuardarCita",
        async: !1,
        data: o,
        dataType: "json",
        success: function (o) {
            if (o.IdCitaPaquete != 0){
                // $(".datos-pacientes .dato-folio-paquete").html(o.IdCitaPaquete);
                // $(".folio-paquete").show();
                      }
            console.log(o),
                1 == o.status
                    ? ($(".datos-pacientes .nombre-cita-paciente").html($("#nombre_paciente_cita").val()),
                      $(".datos-pacientes .nombre-cita-clinica").html($("#clinica_cita option:selected").html()),
                      $(".datos-pacientes .dato-nombre").html($("#nombre_paciente_cita").val() + " " + $("#apellidop_paciente_cita").val() + " " + $("#apellidom_paciente_cita").val()),
                      $(".datos-pacientes .dato-folio").html(o.IdCita),
                      $("#codigoQR").attr("src", generarCodigoQR(o.IdCita)),
                      $(".datos-pacientes .dato-toma-muestra").html(o.Consultorio),
                      $(".datos-pacientes .dato-clinica").html($("#clinica_cita option:selected").html()),
                      $(".datos-pacientes .dato-fecha").html($("#fecha_cita").val()),
                      $(".datos-pacientes .dato-hora").html($("#hora_cita option:selected").html()),
                      configCovid.Folio = o.IdCita,
                      coppelPayEnd(o.DatosCorreo, o.DatosMsjWhatsapp, o.IdCita, o.Identity))
                    : 2 == o.status
                    ? ($("#contenedor-error-pago-CPLPY").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500))
                    : 3 == o.status
                    ? ($("#contenedor-error-pago-CPLPY").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500))
                    : 4 == o.status
                    ? ($("#contenedor-error-pago-CPLPY").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500))
                    : 5 == o.status
                    ? ($("#contenedor-error-pago-CPLPY").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500))
                    : 6 == o.status
                    ? ($("#contenedor-error-pago-CPLPY").text(o.msj).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500))
                    : ($(".procesando_datos").hide(), $("#form4").show());
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
function coppelPayEnd(o, a, e, u) {
    var t = { cpl_solicitud: solicitud, cpl_iovation: CPLPY.blackbox, cpl_token: CPLPY.token, cpl_ip: $("#ipVisitante").val() };
    $.ajax({
        type: "POST",
        url: "https://api.coppelpay.com/CoppelPay/confirmacion-pago",
        async: !1,
        data: JSON.stringify(t),
        dataType: "json",
        contentType: "application/json",
        success: function (t) {
            "SUCCESS" == t.code
                ? confirmarPagoCPLPY(JSON.parse(t.data), o, a, u)
                : (cancelarCita(e), $("#contenedor-error-pago-CPLPY").text(t.message).slideDown(), $(".procesando_datos").hide(), $("#form4").show(), $("#form4 > div").animate({ scrollTop: 5e3 }, 500));
        },
        error: function (o, a, t) {
            console.log(t),
                cancelarCita(e),
                $("#contenedor-error-pago-CPLPY").text("No se puede confirmar pago, intente más tarde.").slideDown(),
                $(".procesando_datos").hide(),
                $("#form4").show(),
                $("#form4 > div").animate({ scrollTop: 5e3 }, 500);
        },
    });
}
function confirmarPagoCPLPY(o, a, e, u) {
    var t = {
        OrigenCita: 0,
        IdIntento: configCovid.idIntento,
        IdConfirmacion: o.cpl_auth_code,
        Confirmacion: JSON.stringify(o),
        Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
        DatosCorreo: a,
        Telefono: $("#tel")
            .val()
            .replace(/[^0-9]/g, ""),
        FechaCita: $("#fecha_cita").val(),
        MensajeWhatsapp: e,
        Identity: u,
        Monto: o.cpl_amount,
    };
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/ConfirmarPagoCoppelPay",
        async: !1,
        data: t,
        dataType: "json",
        success: function (o) {
            1 == o.status && mostrarExito(5), ActualizarFlagCuestionario();
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
function cancelarCita(o) {
    var a = { IdCita: o.toString(), IdPaciente: configCovid.idPaciente, IdHoraMkt: $("#hora_cita").val(), IdSucursal: parseInt($("#clinica_cita").val()), FechaCita: $("#fecha_cita").val() };
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "/CancelacionCita",
        async: !1,
        data: a,
        dataType: "json",
        success: function (o) {
            o.status;
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
function ScrollTop() {
    $(window).width() <= 1024 && $("html, body").animate({ scrollTop: $(".form-content").offset().top - 50 }, 2e3);
}
var EliminarAcentos = (function () {
    for (var o = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç", a = {}, e = 0, t = o.length; e < t; e++) a[o.charAt(e)] = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc".charAt(e);
    return function (o) {
        for (var e = [], t = 0, i = o.length; t < i; t++) {
            var n = o.charAt(t);
            a.hasOwnProperty(o.charAt(t)) ? e.push(a[n]) : e.push(n);
        }
        return e.join("");
    };
})();
function soloNumeros(e){
    var charCode = (e.which) ? e.which : e.keyCode
    if (charCode > 31 && (charCode < 48 || charCode > 57))
        return false;
    return true;
}
function crearJsonDatosPaciente(pago){
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = today.getFullYear();

    today = dd + '/' + mm + '/' + yyyy;
    var tipo_pago = 0;  // 2 - Efectivo / 3 - Tarjeta / 4 - Oxxo / 5 - Coppel 
    tipo_pago = pago;
    return{
        SubEstudioId: 2402,
        SubEstudioVal: "SARS-COV-2 (COVID-19)",
        Nombre: EliminarAcentos($("#nombre_paciente_cita").val()),
        Paterno: EliminarAcentos($("#apellidop_paciente_cita").val()),
        Materno: EliminarAcentos($("#apellidom_paciente_cita").val()),
        FechaNacimiento: $("#fechanac_paciente_cita").val(),
        Correo: null == $("#correo").val() || null == $("#correo").val() || "" == $("#correo").val() ? "generico" + HoraCorreo + "@gmail.com" : $("#correo").val(),
        TelefonoCelular: $("#tel")
        .val()
        .replace(/[^0-9]/g, ""),
        FechaRegistro: today,
        Estatus: 1,
        idtipopago: tipo_pago,
        SucursalVal:$("#clinica_cita option:selected").text(),
        SucursalId: $("#clinica_cita").val(),
        IdCitaSisPrev: 0,
        Fecha: $("#fecha_cita").val(),
        HorarioText: $("#hora_cita option:selected").text(),
        OrigenCita: 0,
        Estado: $("#estado_clinica_cita option:selected").text(),
        IdEstado: $("#estado_clinica_cita").val(),
        Municipio: $("#MunicipioPaciente option:selected").text(),
        IdMunicipio: $("#MunicipioPaciente").val(),
        Colonia: $("#colonia_cita option:selected").text(),
        IdColonia: $("#colonia_cita").val(),
        CodigoPostal: $("#codigo_postal_cita").val(),
        Calle: $("#calle_cita").val(),
        Numero: $("#numero_casa_cita").val(),
        FechaSintomas: $("#FechaSintomas").val()
    }
}

function guardarBitacora(tipoPago) {
    var datos = crearJsonDatosPaciente(tipoPago);
    var sucursal = $("#clinica_cita").val();
    if(sucursal != 109 && sucursal != 150 && sucursal != 41 && sucursal != 6 && sucursal != 5 && sucursal != 1 )
    {
        return;
    }
    $.ajax({
        type: "POST",
        url: "https://bitacora-covid.salud-digna.site/guardar/bitacora",
        data: JSON.stringify(datos),
        dataType: "json",
        contentType: "application/json",
        success: function (o) {
            o.status;
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}
function colorearDias(diasDisponiblesJson, date) {
    var dd = String(date.getDate()).padStart(2, '0');
    var mm = String(date.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = date.getFullYear();
    date = dd + '/' + mm + '/' + yyyy;
    
    obj = diasDisponiblesJson;
    for (var i = 0; i < obj.sucursalFechas.length; i++) {
        if (obj.sucursalFechas[i].Fecha == date.toString()) { 
            //console.log(obj.sucursalFechas[i].Fecha + " : " + obj.sucursalFechas[i].TieneHorarios);
            if(obj.sucursalFechas[i].TieneHorarios){
                return [true, 'tieneHorarios', ""]; //Si tiene horarios color verde
            }
            else{
                return [true, 'noTieneHorarios', ""]; //No tiene horarios color rojo
            }
        }
    }
    return [true, ''];
}
function ObtenerDiasDisponiblesPorClinica(sucursal) {
    $(".overlay_loading").css("display", "flex");
    sucursal = app.IdSucursal;

    if (sucursal == 0) {
        sucursal = $("#clinica_cita").val();
    }

   //Arreglo donde estaran todas las fechas
   let fechas = [];

   $.ajax({
    async: false,
    type: "GET",
    url: "https://servicios.salud-digna.org/horarios/pcr/diasdisponibles?sucursal="+parseInt(sucursal),
    dataType: "json",
    contentType: "application/json",
    success: function (response) {
    response.map(function (a, i) {
        let objeto = {
            Fecha: a.fecha,
            TieneHorarios: false
        };
        if (a.horarios >= 1)
        {               
                objeto.TieneHorarios = true;
        }

        fechas.push(objeto);
    });
    },
    error: function (o, a, e) {
        console.log("Ocurrio un error en consultar los horarios disponibles antigeno para pintar las fechas disponibles o no disponibles");
    },
});

   let objetoMandar = {
       idSucursal: sucursal,
       status: 1,
       sucursalFechas: fechas
   };
   $(".overlay_loading").css("display", "none");
   return objetoMandar;
}

function tiemposDeEntregaThankYou(sucursal){
    $("#resultadoCategoriaA").css("display", "none");
    $("#resultadoCategoriaB").css("display", "none");
    $("#resultadoCategoriaA2").css("display", "none");
    $("#resultadoCategoriaB2").css("display", "none");

    $.ajax({
        type: "GET",
        url: "https://api-ws.salud-digna.site/covid/tiemporesultados/" + sucursal,
        dataType: "json",
        contentType: "application/json",
        global: false,
        async:false,
        success: function (response) {
            console.log(response.tiempo_resultados);
            $("#resultadoCategoriaC").text("Los resultados demoran un promedio de "+response.tiempo_resultados +" en estar listos.");
            $("#resultadoCategoriaC2").text("Los resultados demoran un promedio de "+response.tiempo_resultados + " en estar listos. Los recibiras automaticamente por WhatsApp.");
            $("#resultadosCategoriaC").text("Los resultados demoran un promedio de "+response.tiempo_resultados + " en estar listos. Los recibiras automaticamente por WhatsApp.");
            $("#resultadoCategoriaC").css("display", "inline");
            $("#resultadoCategoriaC2").css("display", "inline");
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}

function SeguridadSocial(){
    var IdSeguridadSocial = parseInt($("#Seguridad_social").val());
    if ( IdSeguridadSocial == 138 ) {
        return 2;
    }else if( IdSeguridadSocial == 139 ){
        return 3;
    }else if( IdSeguridadSocial == 141 ){
        return 12;
    }else if( IdSeguridadSocial == 169 ){
        return 1;
    }
}

function ActualizarFlagCuestionario() {
    $.ajax({
        type: "POST",
        url: configCovid.urlCovid + "ActualizarFlagCuestionario",
        async: false,
        data: { IdFolio: configCovid.Folio, IdIntento: 1 },
        dataType: "json",
        success: function (o) {
            console.log(o);
        },
        error: function (o, a, e) {
            console.log(e);
        },
    });
}